<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD with AJAX</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>CRUD Example with AJAX</h1>
    <form id="addForm">
        <input type="hidden" name="action" value="insert">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
        <label for="owner">Owner:</label>
        <input type="text" id="owner" name="owner" required>
        <label for="species">Species:</label>
        <input type="text" id="species" name="species" required>
        <label for="sex">Sex:</label>
        <select id="sex" name="sex" required>
            <option value="m">Male</option>
            <option value="f">Female</option>
        </select>
        <label for="birth">Birth Date:</label>
        <input type="date" id="birth" name="birth" required>
        <label for="death">Death Date:</label>
        <input type="date" id="death" name="death">
        <button type="submit">Add</button>
    </form>
    <hr>
    <table id="petsTable" border="1">
        <thead>
            <tr>
                <th>Name</th>
                <th>Owner</th>
                <th>Species</th>
                <th>Sex</th>
                <th>Birth</th>
                <th>Death</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be populated dynamically -->
        </tbody>
    </table>

    <script>
        const CGI_URL = '../cgi-bin/crud.pl';

        // Fetch all pets and display them
        function fetchPets() {
            $.post(CGI_URL, { action: 'fetch' }, function (response) {
                if (response.status === 'success') {
                    const tbody = $('#petsTable tbody');
                    tbody.empty();
                    response.data.forEach(pet => {
                        tbody.append(`
                            <tr>
                                <td><input type="text" class="name" value="${pet.name}"></td>
                                <td><input type="text" class="owner" value="${pet.owner}"></td>
                                <td><input type="text" class="species" value="${pet.species}"></td>
                                <td>
                                    <select class="sex">
                                        <option value="m" ${pet.sex === 'm' ? 'selected' : ''}>Male</option>
                                        <option value="f" ${pet.sex === 'f' ? 'selected' : ''}>Female</option>
                                    </select>
                                </td>
                                <td><input type="date" class="birth" value="${pet.birth}"></td>
                                <td><input type="date" class="death" value="${pet.death || ''}"></td>
                                <td>
                                    <button class="update" data-name="${pet.name}">Update</button>
                                    <button class="delete" data-name="${pet.name}">Delete</button>
                                </td>
                            </tr>
                        `);
                    });
                }
            }, 'json');
        }

        // Handle form submission for adding a pet
        $('#addForm').on('submit', function (e) {
            e.preventDefault();
            const formData = $(this).serialize();
            $.post(CGI_URL, formData, function (response) {
                if (response.status === 'success') {
                    fetchPets();
                    $('#addForm')[0].reset();
                }
            }, 'json');
        });

        // Handle update and delete actions
        $('#petsTable').on('click', '.update', function () {
            const row = $(this).closest('tr');
            const data = {
                action: 'update',
                old_name: $(this).data('name'),
                name: row.find('.name').val(),
                owner: row.find('.owner').val(),
                species: row.find('.species').val(),
                sex: row.find('.sex').val(),
                birth: row.find('.birth').val(),
                death: row.find('.death').val()
            };
            $.post(CGI_URL, data, function (response) {
                if (response.status === 'success') {
                    fetchPets();
                }
            }, 'json');
        });

        $('#petsTable').on('click', '.delete', function () {
            const name = $(this).data('name');
            $.post(CGI_URL, { action: 'delete', name }, function (response) {
                if (response.status === 'success') {
                    fetchPets();
                }
            }, 'json');
        });

        // Initial fetch
        fetchPets();
    </script>
</body>
</html>
